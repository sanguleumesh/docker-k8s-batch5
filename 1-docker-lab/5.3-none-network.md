

# 1. Verify Docker installation & check existing networks
docker --version
docker info
docker network ls

# 2. Run a container with the None network
docker run -dit --network none --name isolated_container --cap-add=NET_ADMIN --cap-add=NET_RAW busybox sh

# 3. Verify networking inside the container
docker exec -it isolated_container sh -c "ip a"

# 4. Get the container’s PID
docker inspect -f '{{.State.Pid}}' isolated_container

# 5. Create a virtual Ethernet (veth) pair
sudo ip link add veth-host type veth peer name veth-container

# 6. Move veth-container into the container
sudo ip link set veth-container netns $(docker inspect -f '{{.State.Pid}}' isolated_container)

# 7. Assign an IP to the container’s interface
docker exec -it isolated_container ip addr add 192.168.1.100/24 dev veth-container
docker exec -it isolated_container ip link set veth-container up

# 8. Assign an IP to the host’s interface
sudo ip addr add 192.168.1.1/24 dev veth-host
sudo ip link set veth-host up

# 9. Verify connectivity between host and container
ping -c 4 192.168.1.100
docker exec -it isolated_container ping -c 4 192.168.1.1

# 10. Set up routing inside the container
docker exec -it isolated_container ip route del default
docker exec -it isolated_container ip route add default via 192.168.1.1

# 11. Enable IP forwarding on the host
sudo sysctl -w net.ipv4.ip_forward=1
echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# 12. Enable NAT (Masquerading) on the host
sudo iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 13. Allow forwarding in iptables
sudo iptables -P FORWARD ACCEPT

# 14. Test external connectivity
docker exec -it isolated_container ping -c 4 8.8.8.8
docker exec -it isolated_container nslookup google.com

# 15. If DNS fails, manually set nameserver
docker exec -it isolated_container sh -c "echo 'nameserver 8.8.8.8' > /etc/resolv.conf"
docker exec -it isolated_container nslookup google.com

# 16. Cleanup
docker stop isolated_container
docker rm isolated_container
sudo ip link delete veth-host
